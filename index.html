<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa pacientes AMMUTRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --hosp-navy: #0f172a; --hosp-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --block-bg: #f1f5f9; 
            --text-main: #1e293b; --text-sub: #64748b;
        }
        body.dark-mode {
            --hosp-bg: #020617; --card-bg: #0f172a; --border-color: #1e293b;
            --block-bg: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--hosp-bg); margin: 0; padding: 0; color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .main-container { width: 95%; max-width: 500px; margin: 0 auto; padding-bottom: 120px; }
        .sticky-header { position: sticky; top: 0; background: var(--hosp-bg); z-index: 1000; padding: 15px 0 10px 0; border-bottom: 2px solid var(--hosp-navy); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 5px; }
        .header h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; font-weight: 800; color: var(--hosp-navy); }
        body.dark-mode .header h2 { color: #fff; }
        .search-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 5px; }
        .search-field { position: relative; }
        .search-field label { font-size: 0.6rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; margin-bottom: 4px; text-align: center; display: block; }
        .search-field input { padding: 10px 5px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.85rem; text-align: center; width: 100%; background: var(--card-bg); color: var(--text-main); box-sizing: border-box; }
        .voice-btn { position: absolute; right: 5px; bottom: 8px; background: none; border: none; cursor: pointer; opacity: 0.4; font-size: 0.8rem; }
        .filter-controls { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; }
        #contador { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); }
        .action-btns { display: flex; gap: 8px; }
        .btn-small { background: none; border: 1px solid var(--text-sub); color: var(--text-sub); font-size: 0.6rem; font-weight: 800; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .card { background: var(--card-bg); border-radius: 8px; margin: 15px 0; border: 1px solid var(--border-color); overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-header { background: var(--hosp-navy); color: white; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; align-items: center; }
        .card-body { display: none; padding: 0 10px 15px 10px; }
        .card.expanded .card-body { display: block; }
        .info-block { padding: 12px 15px; border-radius: 4px; background: var(--block-bg); margin-top: 10px; border: 1px solid var(--border-color); }
        .label { font-size: 0.6rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .value { font-size: 0.9rem; font-weight: 600; line-height: 1.4; white-space: pre-wrap; }
        .btn-copy { width: 100%; margin-top: 15px; padding: 12px; background: var(--hosp-navy); color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; }
        #modal-cadastro { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--hosp-bg); z-index: 2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .form-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); font-family: inherit; }
        .fab-container { position: fixed; bottom: 25px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1001; }
        .btn-fab { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .btn-del { background: none; border: none; color: #f87171; font-size: 1rem; cursor: pointer; padding: 5px; }

        @media print {
            body { background-color: white !important; color: black !important; }
            .sticky-header, .fab-container, .btn-copy, .voice-btn, .btn-del, .action-btns, #contador { display: none !important; }
            .main-container { width: 100%; max-width: none; margin: 0; padding: 0; }
            .card { border: 1px solid #000 !important; box-shadow: none !important; margin: 10px 0 !important; page-break-inside: avoid; }
            .card-header { background: #f0f0f0 !important; color: #000 !important; border-bottom: 1px solid #000 !important; }
            .card-body { display: block !important; padding: 5px 10px !important; }
            .info-block { background: #fff !important; border: 1px solid #ddd !important; margin-top: 5px !important; padding: 8px !important; }
            .label { color: #444 !important; }
            .value { color: #000 !important; font-size: 0.85rem !important; }
        }
    </style>
</head>
<body class="dark-mode">
<div class="main-container">
    <div class="sticky-header">
        <div class="header">
            <h2>Mapa pacientes AMMUTRO</h2>
            <button onclick="toggleTheme()" id="themeBtn" style="background:none; border:none; font-size:1.1rem; cursor:pointer;">üåì</button>
        </div>
        <div class="search-grid">
            <div class="search-field"><label>Leito</label><input type="text" id="sLeito" placeholder="N¬∫" onkeyup="filtrar()"><button class="voice-btn" onclick="startVoice('sLeito')">üé§</button></div>
            <div class="search-field"><label>Paciente</label><input type="text" id="sNome" placeholder="Nome" onkeyup="filtrar()"><button class="voice-btn" onclick="startVoice('sNome')">üé§</button></div>
            <div class="search-field"><label>NA</label><input type="text" id="sNA" placeholder="ID" onkeyup="filtrar()"></div>
        </div>
        <div class="filter-controls">
            <span id="contador">Sincronizando...</span>
            <div class="action-btns">
                <button class="btn-small" onclick="window.print()">üñ®Ô∏è PDF</button>
                <button class="btn-small" onclick="limpar()">LIMPAR E FECHAR</button>
            </div>
        </div>
    </div>
    <div id="app"></div>
</div>

<div id="modal-cadastro">
    <h3 style="margin-bottom:20px;">CADASTRAR PACIENTE</h3>
    <form id="formPaciente">
        <input type="text" id="fLeito" class="form-input" placeholder="Leito">
        <input type="text" id="fNA" class="form-input" placeholder="NA">
        <input type="text" id="fNome" class="form-input" placeholder="Nome Completo">
        <input type="text" id="fConvenio" class="form-input" placeholder="Conv√™nio">
        <textarea id="fHD" class="form-input" placeholder="Diagn√≥stico (HD)"></textarea>
        <textarea id="fDieta" class="form-input" placeholder="Dietoterapia"></textarea>
        
        <label class="label" style="margin-top: 8px;">Evacua√ß√£o (Data)</label>
        <input type="date" id="fEvac" class="form-input">

        <textarea id="fExames" class="form-input" placeholder="Exames"></textarea>
        <textarea id="fMeds" class="form-input" placeholder="Medica√ß√µes"></textarea>
        <textarea id="fNutri" class="form-input" placeholder="Obs Nutri√ß√£o"></textarea>
        <input type="text" id="fEquipe" class="form-input" placeholder="Equipe">
    </form>
    <button onclick="salvar()" id="btnSalvar" style="width:100%; padding:15px; background:#0284c7; color:white; font-weight:800; border:none; border-radius:8px; margin-top:10px;">SALVAR NA PLANILHA</button>
    <button onclick="fechar()" style="width:100%; padding:12px; border:none; color:var(--text-sub); cursor:pointer;">CANCELAR</button>
</div>

<div class="fab-container">
    <button class="btn-fab" style="background:#0284c7" onclick="document.getElementById('modal-cadastro').style.display='block'">+</button>
    <button class="btn-fab" style="background:var(--hosp-navy)" onclick="buscar()">‚Üª</button>
</div>

<script>
    const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbxyzQsXrRmDtUArso3PV3XR8VLP5eJB4OuCUdalg8dWIEeo8SoD1KkiKfOEkpIEHPYt/exec'; 
    let dadosLocais = [];

    if (localStorage.getItem('ammutro-theme') === 'light') document.body.classList.remove('dark-mode');

    function formatarData(dataRaw) {
        if (!dataRaw || dataRaw === '-') return '-';
        const dataObj = new Date(dataRaw);
        if (isNaN(dataObj.getTime())) return dataRaw;
        return dataObj.toLocaleDateString('pt-BR');
    }

    async function buscar() {
        document.getElementById('contador').innerText = "Sincronizando...";
        try {
            const res = await fetch(URL_SCRIPT);
            dadosLocais = await res.json();
            render();
        } catch (e) { document.getElementById('contador').innerText = "Erro."; }
    }

    function render() {
        const app = document.getElementById('app');
        app.innerHTML = dadosLocais.map((p, i) => `
            <div class="card" data-leito="${p.leito || ''}" data-nome="${p.nome || ''}" data-na="${p.na || ''}" onclick="this.classList.toggle('expanded')">
                <div class="card-header">
                    <span>LEITO: ${p.leito || '-'} | NA: ${p.na || '-'}</span>
                    <button class="btn-del" onclick="event.stopPropagation(); excluir(${p.row_index}, '${p.nome}')">üóëÔ∏è</button>
                </div>
                <div class="info-block" style="background:transparent; border:none; margin-bottom:0;">
                    <div style="font-size:1.1rem; font-weight:700;">${p.nome || '-'}</div>
                    <div style="font-size:0.8rem; color:var(--text-sub)">${p.convenio || '-'}</div>
                </div>
                <div class="card-body">
                    <div class="info-block"><span class="label">Diagn√≥stico</span><div class="value">${p.hd || '-'}</div></div>
                    <div class="info-block"><span class="label">Dieta</span><div class="value">${p.dietoterapia || '-'}</div></div>
                    <div class="info-block"><span class="label">Evacua√ß√£o</span><div class="value">${formatarData(p.evacuacao)}</div></div>
                    <div class="info-block"><span class="label">Exames</span><div class="value">${p.exames || '-'}</div></div>
                    <div class="info-block"><span class="label">Medica√ß√µes</span><div class="value">${p.medicacoes || '-'}</div></div>
                    <div class="info-block"><span class="label">Obs Nutri√ß√£o</span><div class="value">${p.obs_nutri || '-'}</div></div>
                    <div class="info-block"><span class="label">Equipe</span><div class="value">${p.obs_nutro || p.equipe || '-'}</div></div>
                    <button class="btn-copy" id="btn-cp-${i}" onclick="event.stopPropagation(); copiar(${i})">üìã COPIAR RESUMO</button>
                </div>
            </div>`).join('');
        filtrar();
    }

    async function excluir(rowIndex, nome) {
        if (confirm(`Deseja realmente apagar o paciente ${nome}?\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
            document.getElementById('contador').innerText = "Excluindo...";
            try {
                await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'DELETE', row_index: rowIndex }) });
                alert("Paciente removido!");
                buscar();
            } catch(e) { alert("Erro ao excluir."); }
        }
    }

    async function salvar() {
        const btn = document.getElementById('btnSalvar');
        btn.innerText = "Enviando..."; btn.disabled = true;
        const payload = { 
            leito: document.getElementById('fLeito').value, 
            na: document.getElementById('fNA').value, 
            nome: document.getElementById('fNome').value, 
            convenio: document.getElementById('fConvenio').value, 
            hd: document.getElementById('fHD').value, 
            dietoterapia: document.getElementById('fDieta').value, 
            evacuacao: document.getElementById('fEvac').value, 
            exames: document.getElementById('fExames').value, 
            medicacoes: document.getElementById('fMeds').value, 
            obs_nutri: document.getElementById('fNutri').value, 
            obs_nutro: document.getElementById('fEquipe').value 
        };
        try {
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Sucesso!");
            fechar(); buscar();
        } catch(e) { alert("Erro ao salvar."); }
        btn.innerText = "SALVAR NA PLANILHA"; btn.disabled = false;
    }

    function copiar(i) {
        const p = dadosLocais[i];
        const evacLida = formatarData(p.evacuacao);
        const txt = `*RESUMO PACIENTE - AMMUTRO*\n------------------------------\n*LEITO:* ${p.leito || '-'}\n*NA:* ${p.na || '-'}\n*NOME:* ${p.nome || '-'}\n*CONV√äNIO:* ${p.convenio || '-'}\n------------------------------\n*DIAGN√ìSTICO:* ${p.hd || '-'}\n*DIETOTERAPIA:* ${p.dietoterapia || '-'}\n*EVACUA√á√ÉO:* ${evacLida}\n*EXAMES:* ${p.exames || '-'}\n*MEDICA√á√ïES:* ${p.medicacoes || '-'}\n------------------------------\n*OBS NUTRI√á√ÉO:* ${p.obs_nutri || '-'}\n*EQUIPE:* ${p.obs_nutro || p.equipe || '-'}`;
        navigator.clipboard.writeText(txt).then(() => {
            const btn = document.getElementById(`btn-cp-${i}`);
            btn.innerText = "‚úÖ COPIADO!";
            setTimeout(() => { btn.innerText = "üìã COPIAR RESUMO"; }, 2000);
        });
    }

    function fechar() { 
        document.getElementById('modal-cadastro').style.display='none'; 
        document.getElementById('formPaciente').reset();
    }

    function limpar() {
        document.getElementById('sLeito').value = ""; document.getElementById('sNome').value = ""; document.getElementById('sNA').value = "";
        document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
        filtrar();
    }

    function filtrar() {
        const leitoVal = document.getElementById('sLeito').value.toLowerCase();
        const nomeVal = document.getElementById('sNome').value.toLowerCase();
        const naVal = document.getElementById('sNA').value.toLowerCase();
        const cards = document.querySelectorAll('.card');
        let visiveis = 0;
        cards.forEach(card => {
            const cLeito = card.getAttribute('data-leito').toLowerCase();
            const cNome = card.getAttribute('data-nome').toLowerCase();
            const cNA = card.getAttribute('data-na').toLowerCase();
            if (cLeito.includes(leitoVal) && cNome.includes(nomeVal) && cNA.includes(naVal)) {
                card.style.display = "block";
                visiveis++;
            } else { card.style.display = "none"; }
        });
        document.getElementById('contador').innerText = visiveis + " pacientes encontrados";
    }

    function startVoice(id) {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = 'pt-BR';
        rec.onresult = (e) => { 
            let t = e.results[0][0].transcript.toLowerCase();
            document.getElementById(id).value = id === 'sLeito' ? t.replace(/\D/g, "") : t;
            filtrar();
        };
        rec.start();
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('ammutro-theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    buscar();
</script>
</body>
</html>